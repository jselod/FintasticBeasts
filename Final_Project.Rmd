---
title: "Final Project"
author: "Michael Bevilacqua, Jonah Kotzen, Jaan Selod"
date: "2024-04-23"
output: html_document
bibliography: BIOL5380.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(av)
library(ggplot2)
```

# Introduction:


The  Myctophidae family includes the species *Diaphus mollis*, mesopelagic fish that reach body lengths of 6.6 cm [@Froese2024]. These myctopids are often called lantern fish, and can be found in Atlantic and Indian Oceans. They have a high evolutionary radiation, with high variability in phenotypes. This has resulted in the Myctophidae being one of the most abundant and "most species-rich deep-sea fish groups" @Tuset2018there. In this study, we will be looking at the effect of Kármán vortices on several deceased Diaphus mollis, which vary in size. These vortices form after a constant flow of water hits an object in the water, which in a natural habitat could be a rock, or a tree, however in this circumstance, a wooden dowel is used. When the myctophid is placed in this street of vortices, fish "swimming behind cylinders adopt a distinctive, previously undescribed pattern of movement in order to hold station, which we term the Kármán gait" @Liao2003there. This study will look to analyze ...

![Diaphus mollis](https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Myctophum_punctatum1.jpg/640px-Myctophum_punctatum1.jpg)

metadata: specimen_speed.csv

# Methods:

In order to complete this study, our group first planned out an experimental design in order to study the phenomenon known as  Kármán gaiting within the species Diapus mollis. In order to do so, we utilized 5 dead myctophids, each varying in size and weight (between 28 mm - 53 mm, and 0.16 g - 1.477 g). These fish were then attached to a thin piece of floss, inserted into their eye cavities. They were then placed into a swim tunnel, and pulled slowly behind a wooden dowel, until they displayed the  Kármán gait movement. Each specimen was swum at two different flow rates (25 cm/s and 28 cm/s). Video was taken of each trial with an iPhone, while the lights were turned off to ensure better video quality. This process was repeated 10 times, twice for each specimen. These videos were then taken and analyzed via ImageJ with the MTrackJ plugin, in order to map the coordinates of their movements. 


# Results:
```{r loadinfo, echo = F, warning = F, message = F}
specimens <- read.csv("specimen_info.csv")
specimens %>%
  kable(caption = "Table 1: Specimen Information")
```

```{r vidanalysis, eval = F}
#code used to generate avi files from iphone videos

f <- list.files(full.names = T, pattern = ".MOV")
dir.create("images")
for (i in f) {
  if(dir.exists("images")) unlink("images", recursive = T)
  av_video_images(i, destdir = "images", format = "tiff")
  f.i <- list.files("images", full.names = T)
  av_encode_video(f.i, gsub("MOV", "avi", basename(i)), codec = "rawvideo")
}
```

# XY Processing

```{r chunk1, include=TRUE}

# List all xy data files
file_list <- list.files(pattern = "_xy.csv")

# Read data and extract metadata from filenames
data_list <- lapply(file_list, function(file) {
  data <- read.csv(file)
  parts <- unlist(strsplit(file, "_"))
  species <- parts[1]
  flow <- gsub("xy.csv", "", parts[2])
  data <- mutate(data, Species = species, Flow = flow)
  return(data)
})

# Combine all data into one dataframe
combined_data <- bind_rows(data_list)

```

```{r chunk2, include=TRUE}
# Remove unnecessary columns and clean names
processed_data1 <- combined_data %>%
  select(-matches("I..val.|Len..mm.|D2S..mm.|D2R..mm.|D2P..mm.|v..mm.sec.|x..unit.|y..unit.|Len..unit.|D2S..unit.|D2R..unit.")) %>%
  rename(
    x = x..mm.,
    y = y..mm.,
    time = t..sec.,
    alpha = α..deg.,
    delta_alpha = Δα..deg.
  )


# Rename the column for clarity
processed_data1 <- processed_data1 %>%
  rename(Specimen = Species)

# Convert Specimen to character type in the specimens dataframe
specimens$Specimen <- as.character(specimens$Specimen)

# Merging specimen data with the main dataset
processed_data1 <- processed_data1 %>%
  left_join(specimens, by = c("Specimen" = "Specimen"))

```


# Graphs

### Plotting oscillatory patterns across flow speeds

```{r chunk4, include=TRUE}
ggplot(processed_data1, aes(x = PID, y = y, group = interaction(Specimen, Flow), color = as.factor(Flow))) +
  geom_line() +
  facet_wrap(~Specimen) +
  labs(title = "Oscillatory Patterns Across Flow Speeds",
       x = "Frame (PID)", y = "Y Coordinate (mm)",
       color = "Flow Speed") +
  theme_minimal()


```

### Mean Deviations in Y-Coordinates

```{r chunk5, include=TRUE}
# Calculate mean deviations for each species and flow
deviation_data <- processed_data1 %>%
  group_by(Specimen, Flow) %>%
  summarise(mean_y = mean(y, na.rm = TRUE), sd_y = sd(y, na.rm = TRUE)) %>%
  ungroup()

# Plot mean deviations
ggplot(deviation_data, aes(x = Specimen, y = mean_y, fill = as.factor(Flow))) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = mean_y - sd_y, ymax = mean_y + sd_y), width = .2, position = position_dodge(.9)) +
  labs(title = "Mean Deviations in Y-Coordinates Across Species",
       x = "Specimen", y = "Mean Y Coordinate (mm)",
       fill = "Flow Speed") +
  theme_minimal()

```


```{r meandev, include=FALSE}
# Calculate mean Y deviations for each specimen
processed_data2 <- processed_data1 %>%
  group_by(Specimen, Body_Length_mm, Mass_g, Flow) %>%
  summarise(mean_y_deviation = mean(y, na.rm = TRUE),
            .groups = 'drop') # Ensures the data frame does not remain grouped

```

### Combined plot for Body Length and Mass vs. Mean Y Deviation

```{r chunk6, include=TRUE}
combined_data <- processed_data2 %>%
  gather(key = "Metric", value = "Value", Body_Length_mm, Mass_g) 

ggplot(combined_data, aes(x = Value, y = mean_y_deviation, color = as.factor(Specimen))) +
  geom_point() +
  geom_smooth(method = "lm") + 
  facet_wrap(~ Metric, scales = "free_x") +
  labs(title = "Effect of Body Metrics on Mean Y-Coordinate Deviation",
       x = "Metric Value", y = "Mean Y Deviation (mm)",
       color = "Specimen") +
  theme_minimal()


```


### Effect of Flow Speed on PID Amount
```{r chunk6, include=TRUE}
ggplot(processed_data1, aes(x = Flow, y = PID, group = Flow)) +
  geom_boxplot() +
  labs(title = "Effect of Flow Speed on PID Amount",
       x = "Flow Speed (cm/s)", y = "PID (Frame Count)") +
  theme_minimal()
```

### Effect of Flow Speed on Mean Y Deviation

```{r chunk6.5, include=TRUE}
ggplot(processed_data2, aes(x = Flow, y = mean_y_deviation, group = Flow)) +
  geom_boxplot() +
  labs(title = "Effect of Flow Speed on PID Amount",
       x = "Flow Speed (cm/s)", y = "Mean Y Deviation") +
  theme_minimal()
```



```{r chunk7, include=TRUE}
# ANOVA for Body Length
anova_length <- aov(mean_y_deviation ~ Body_Length_mm, data = processed_data2)
summary(anova_length)

# ANOVA for Mass
anova_mass <- aov(mean_y_deviation ~ Mass_g, data = processed_data2)
summary(anova_mass)

# # Running ANOVA for flow speed
anova_flow <- aov(mean_y_deviation ~ Flow, data = processed_data2)
summary(anova_flow)

```

# Discussion:

# Author Contributions:

# References:
